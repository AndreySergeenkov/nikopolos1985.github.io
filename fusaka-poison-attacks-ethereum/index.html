<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Address Poisoning Losses Surged 13x After Ethereum's Fusaka Upgrade - Andrey Sergeenkov</title>
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <link rel="alternate" type="application/rss+xml" title="Andrey Sergeenkov RSS Feed" href="/feed.xml">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6FZQZRN4S3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-6FZQZRN4S3');
    </script>
    <!-- Ahrefs Web Analytics -->
    <script src="https://analytics.ahrefs.com/analytics.js" data-key="NPIdMif9bRIzbz2xRz7s/Q" async></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.7;
            color: #333;
            max-width: 720px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #fff;
        }
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .back-link {
            display: inline-block;
            color: #333;
            text-decoration: none;
            background-color: #e6f3e6;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }
        .back-link:hover {
            background-color: #c8e6c8;
        }
        .top-follow {
            font-size: 14px;
            color: #666;
        }
        .top-follow a, .author-bio a {
            background-color: #fdffc8;
        }
        .article-header {
            margin-bottom: 40px;
        }
        h1 {
            font-size: 32px;
            font-weight: 600;
            line-height: 1.3;
            margin: 0 0 20px 0;
        }
        .article-meta {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .tldr {
            background: #f8f9fa;
            border-left: 4px solid #dc3545;
            padding: 20px;
            margin: 30px 0;
            border-radius: 0 8px 8px 0;
        }
        .tldr-title {
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            color: #dc3545;
            margin-bottom: 12px;
        }
        .tldr ul {
            margin: 0;
            padding-left: 20px;
        }
        .tldr li {
            margin-bottom: 8px;
            font-style: italic;
            color: #555;
        }
        h2 {
            font-size: 24px;
            font-weight: 600;
            margin-top: 50px;
            margin-bottom: 20px;
            color: #222;
        }
        p {
            margin-bottom: 20px;
            font-size: 16px;
        }
        a {
            color: #333;
            text-decoration: none;
            background-color: #e6f3e6;
            padding: 1px 4px;
            border-radius: 3px;
            transition: background-color 0.2s ease;
        }
        a:hover {
            background-color: #c8e6c8;
            text-decoration: underline;
        }
        .note {
            background: #f8f9fa;
            padding: 16px 20px;
            border-radius: 6px;
            margin: 20px 0;
            color: #555;
            font-size: 15px;
            line-height: 1.7;
        }
        .note a {
            color: #555;
        }
        .highlight {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin: 30px 0;
        }
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 30px 0;
            border-radius: 0 8px 8px 0;
        }
        .chart-box {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px 20px 14px;
            margin: 30px 0;
            background: #fff;
        }
        .chart-box h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 2px;
            color: #333;
        }
        .chart-box .chart-subtitle {
            font-size: 13px;
            color: #666;
            margin: 0 0 16px;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
        }
        .chart-container canvas {
            display: block;
        }
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 12px;
        }
        .chart-legend span {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
        }
        .legend-line {
            width: 16px;
            height: 2px;
            display: inline-block;
        }
        .legend-dash {
            width: 16px;
            height: 0;
            border-top: 2px dashed #2a7a2a;
            display: inline-block;
        }
        .chart-source {
            text-align: right;
            margin-top: 6px;
        }
        .chart-source a {
            font-size: 10px;
            color: #bbb;
            background: none;
            padding: 0;
        }
        .chart-source a:hover {
            color: #999;
            background: none;
        }
        .chart-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .chart-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            font-size: 11px;
            color: #888;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
        }
        .chart-btn:hover {
            color: #555;
            background: #eee;
            border-color: #ccc;
            text-decoration: none;
        }
        .chart-btn svg {
            width: 13px;
            height: 13px;
            fill: currentColor;
        }
        .chart-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .chart-modal-overlay.active {
            display: flex;
        }
        .chart-modal {
            background: #fff;
            border-radius: 8px;
            padding: 24px;
            max-width: 960px;
            width: 100%;
            max-height: 90vh;
            position: relative;
        }
        .chart-modal h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 4px;
            color: #333;
        }
        .chart-modal .chart-subtitle {
            font-size: 13px;
            color: #666;
            margin: 0 0 16px;
        }
        .chart-modal-container {
            position: relative;
            width: 100%;
            height: 420px;
        }
        .chart-modal-close {
            position: absolute;
            top: 12px;
            right: 16px;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            background: none;
            border: none;
            line-height: 1;
            padding: 4px;
        }
        .chart-modal-close:hover {
            color: #333;
        }
        @media (max-width: 600px) {
            .chart-modal-container {
                height: 280px;
            }
        }
        .author-box {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 50px;
            padding-top: 30px;
            border-top: 1px solid #eee;
        }
        .author-info {
            flex: 1;
        }
        .author-bio {
            font-size: 14px;
            color: #666;
        }
        @media (max-width: 600px) {
            body {
                padding: 20px 15px;
            }
            h1 {
                font-size: 24px;
            }
            h2 {
                font-size: 20px;
            }
            .chart-container {
                height: 220px;
            }
            .chart-legend {
                flex-wrap: wrap;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="top-nav">
        <a href="../" class="back-link">&larr; Back to Home</a>
        <div class="top-follow">You can follow new articles via <a href="/feed.xml">RSS</a> or <a href="https://x.com/Nikopolos">Twitter</a></div>
    </div>

    <article>
        <header class="article-header">
            <h1>Address Poisoning Losses Surged 13&times; After Ethereum's Fusaka Upgrade</h1>
            <div class="article-meta">By Andrey Sergeenkov &middot; February 18, 2026</div>
        </header>

        <div class="tldr">
            <div class="tldr-title">TL;DR</div>
            <ul>
                <li>Fusaka reduced gas fees 6&times;, making mass poisoning spam cheap enough to scale</li>
                <li>This helped attackers increase poisoning volume 5.6&times;</li>
                <li>In 73 days after Fusaka, victims lost $63.3M</li>
                <li>This is 13&times; more than in the same period before the upgrade ($4.9M)</li>
            </ul>
        </div>

        <p>In my <a href="/record-high-activity-ethereum-2026/">previous article</a>, I wanted to find out what caused the record-high activity on the Ethereum network, and it turned out that 80% of the growth was address poisoning spam, made economically attractive by the Fusaka upgrade reducing gas fees 6 times. At the time, I only had limited data that answered the question of what was behind the growth.</p>

        <div class="note">Address poisoning &mdash; an attack where scammers send tiny or zero-value transactions from addresses that match the first and last characters of the victim's real contacts, hoping the victim will copy the wrong address from their transaction history.</div>

        <p>In this article, I researched how address poisoning grew overall and what the actual results of these attacks were. What's the total damage?</p>

        <p>To answer this question, I built a detection pipeline that scans the Ethereum blockchain from September 1, 2025, through February 13, 2026, covering 93 days before Fusaka and 73 days after. It tracks dust transfers across 101 tokens, and identifies confirmed payoffs.</p>

        <div class="chart-box">
            <h3>Dust attack transactions before and after Fusaka upgrade</h3>
            <p class="chart-subtitle">7-day moving average. Each dust transfer = one attack transaction.</p>
            <div class="chart-container"><canvas id="chart1"></canvas></div>
            <div class="chart-legend">
                <span><span class="legend-line" style="background:#dc3545"></span> Dust transactions (7d avg)</span>
                <span><span class="legend-dash"></span> Pre-Fusaka avg</span>
            </div>
            <div class="chart-actions">
                <button class="chart-btn" onclick="downloadChart('chart1','dust-transactions')"><svg viewBox="0 0 16 16"><path d="M8 12L3 7h3V1h4v6h3L8 12zm-5 2h10v1H3v-1z"/></svg> Download</button>
                <button class="chart-btn" onclick="expandChart('chart1')"><svg viewBox="0 0 16 16"><path d="M2 2h5v1H3v4H2V2zm12 0v5h-1V3h-4V2h5zM2 14v-5h1v4h4v1H2zm12 0h-5v-1h4v-4h1v5z"/></svg> Expand</button>
            </div>
            <div class="chart-source"><a href="https://sergeenkov.com">sergeenkov.com</a></div>
        </div>

        <p>Before Fusaka, attackers were sending an average of 30,000 dust transactions per day. After the upgrade, this jumped to 167,000 per day, a 5.6 times increase.</p>

        <p>The January spike reached 510,000 transactions in a single day. Even excluding that spike, the sustained post-Fusaka level remains at 150,000&ndash;200,000 daily transactions.</p>

        <div class="note">Fusaka &mdash; a major Ethereum network upgrade (December 3, 2025) that expanded the network's capacity to process more transactions at once, making them cheaper. The upgrade is part of Ethereum's effort to attract mass adoption by reducing fees.</div>

        <div class="chart-box">
            <h3>Gas price vs. dust attack volume before and after Fusaka upgrade</h3>
            <p class="chart-subtitle">7-day moving average. Median gas price (gwei) from Dune Analytics overlaid with dust transactions.</p>
            <div class="chart-container"><canvas id="chart3"></canvas></div>
            <div class="chart-legend">
                <span><span class="legend-line" style="background:#e8a838"></span> Median gas price, gwei (left axis)</span>
                <span><span class="legend-line" style="background:#dc3545"></span> Dust transactions (right axis)</span>
            </div>
            <div class="chart-actions">
                <button class="chart-btn" onclick="downloadChart('chart3','gas-vs-dust')"><svg viewBox="0 0 16 16"><path d="M8 12L3 7h3V1h4v6h3L8 12zm-5 2h10v1H3v-1z"/></svg> Download</button>
                <button class="chart-btn" onclick="expandChart('chart3')"><svg viewBox="0 0 16 16"><path d="M2 2h5v1H3v4H2V2zm12 0v5h-1V3h-4V2h5zM2 14v-5h1v4h4v1H2zm12 0h-5v-1h4v-4h1v5z"/></svg> Expand</button>
            </div>
            <div class="chart-source"><a href="https://sergeenkov.com">sergeenkov.com</a></div>
        </div>

        <p>The chart shows a clear inverse correlation between gas price and dust attack volume. The two variables move together continuously: when gas spikes, dust output drops; when gas dips, dust output rises. This dose-response relationship is a strong indicator that the link is causal rather than coincidental.</p>

        <div class="note">A dose-response relationship means the effect scales with the exposure: the bigger the dose, the bigger the response. It is one of the Bradford Hill criteria, a standard framework for distinguishing genuine causes from spurious correlations. Applied here, gas price is the dose and attack volume is the response.</div>

        <p>Because attackers adjust their output day by day in proportion to gas cost, the data rules out the possibility that both trends shifted around the same time for unrelated reasons.</p>

        <p>Also, the day-level precision of this correlation likely means that the poisoning software has a built-in gas price threshold that regulates attack intensity automatically. Such settings are common across both legitimate and malicious Ethereum bots.</p>

        <div class="chart-box">
            <h3>Unique wallets attacked before and after Fusaka upgrade</h3>
            <p class="chart-subtitle">7-day moving average. One wallet = one attack regardless of how many dust transactions hit it.</p>
            <div class="chart-container"><canvas id="chart2"></canvas></div>
            <div class="chart-legend">
                <span><span class="legend-line" style="background:#007bff"></span> Unique wallets (7d avg)</span>
                <span><span class="legend-dash"></span> Pre-Fusaka avg</span>
            </div>
            <div class="chart-actions">
                <button class="chart-btn" onclick="downloadChart('chart2','unique-wallets')"><svg viewBox="0 0 16 16"><path d="M8 12L3 7h3V1h4v6h3L8 12zm-5 2h10v1H3v-1z"/></svg> Download</button>
                <button class="chart-btn" onclick="expandChart('chart2')"><svg viewBox="0 0 16 16"><path d="M2 2h5v1H3v4H2V2zm12 0v5h-1V3h-4V2h5zM2 14v-5h1v4h4v1H2zm12 0h-5v-1h4v-4h1v5z"/></svg> Expand</button>
            </div>
            <div class="chart-source"><a href="https://sergeenkov.com">sergeenkov.com</a></div>
        </div>

        <p>The number of unique wallets receiving poisoning dust rose from 12,000 per day to 38,000 per day, a 3.1 times increase.</p>

        <p>Comparing equal 73-day windows before and after Fusaka:</p>

        <ul>
            <li>Pre-Fusaka (Sep 21 &ndash; Dec 2): $4.9M stolen</li>
            <li>Post-Fusaka (Dec 3 &ndash; Feb 13): $63.3M stolen</li>
        </ul>

        <p>This is a 13-fold increase in stolen funds and a 2.6-fold increase in successful payoff events.</p>

        <p>One transfer accounts for a large share of the post-Fusaka total: $50 million in USDT on December 19. Excluding it, the post-Fusaka total is still $13.3M, a 2.7-fold increase over the pre-Fusaka rate.</p>

        <div class="highlight">
            The $50M case is not an anomaly to be excluded. Address poisoning is a lottery-model attack with millions of cheap dust transactions for a few rare, large payoffs. This is how the attack is designed to work. Cheaper gas means more lottery tickets, which means higher odds of catching a whale.
        </div>

        <p>The link between low fees and attack volume was already documented before Fusaka.</p>

        <ul>
            <li>A Carnegie Mellon University <a href="https://arxiv.org/html/2501.16681v1">study</a> published ten months before the upgrade found <em>"a higher attack prevalence in chains with lower transaction fees."</em></li>
            <li>Seven months before the upgrade, Jameson Lopp of Casa <a href="https://blog.lopp.net/bitcoin-address-poisoning-attacks/">concluded</a> that address poisoning is only economically feasible in low-fee environments.</li>
            <li>A Penn State <a href="https://arxiv.org/abs/2508.12107">study</a> published three months before Fusaka tested 53 Ethereum wallets and found that most failed to warn users about poisoning transfers.</li>
        </ul>

        <p>Despite this, the Ethereum Foundation proceeded with the Fusaka upgrade.</p>

        <p>Address poisoning is not the only attack type whose economics depend on gas cost. Sandwich attacks, fake token airdrops, sweeper bots on compromised wallets, and mass approval drains all become more profitable as fees drop.</p>

        <div class="highlight">
            There is nothing wrong with lowering fees, but the security problems that cheap transactions amplify should have been addressed before the upgrade. When the Ethereum Foundation claims it is building trillion-dollar security, user safety must be the strictest priority over growth metrics.
        </div>

        <h2>Methodology</h2>

        <p>The detector runs as a single SQL pipeline on Google BigQuery's public Ethereum dataset. It first identifies all legitimate ERC-20 and ETH transfers &ge;$1 and extracts a fingerprint for each recipient address (first 3 + last 4 hex characters). It then detects poisoning by matching lookalike addresses against these fingerprints: zero-value ERC-20 transfers initiated by third parties, and ERC-20 or ETH dust transfers &lt;$1 sent to victims within a 300-block window. A confirmed payoff is any subsequent ERC-20 or ETH transfer &ge;$10 from the victim to a lookalike address.</p>

        <p>The charts in this article display dust transfer activity only, as dust transfers are the primary measurable attack vector. Zero-value transfers are not shown on the charts but are used internally by the detector to build a complete map of victim-to-lookalike address pairs.</p>

        <p>All 101 tokens are priced using weekly snapshots (23 dates). Contract addresses are excluded from the victim pool. The pipeline also filters out burn addresses, self-transfers, transfers not initiated by the victim, and cases where the lookalike was a known legitimate recipient before the poisoning event. One bot address that generated thousands of automated micro-transfers to poisoned addresses was excluded from payoff statistics.</p>

        <p>The detector undercounts both attacks and payoffs. It only catches poisoning against addresses that made at least one transfer &ge;$1 during the study period, and only tracks 101 tokens. The $68M figure is a confirmed lower bound. However, testing with various samples of tokens outside the whitelist showed that attacks involving unlisted tokens account for less than 1% of the total.</p>

        <p>This study tracked two types of poisoning transfers: dust transfers and zero-value transfers. There are also other types, including counterfeit token transfers, fake ETH transfers, and approval-based variants. I did not include them because building such queries is significantly more complex and running them on BigQuery is expensive. Dust and zero-value transfers are sufficient to see the full picture, because attackers typically combine several different methods against the same target, and cases where a victim receives only a counterfeit token transfer without accompanying dust or zero-value poisoning are rare.</p>

        <div class="author-box">
            <div class="author-info">
                <div class="author-bio">You can follow new articles via <a href="/feed.xml">RSS</a> or <a href="https://x.com/Nikopolos">Twitter</a>.</div>
            </div>
        </div>
    </article>

    <script>
    (function() {
        var RAW = "2025-09-01,12032,5917\n2025-09-02,19556,10435\n2025-09-03,20830,10035\n2025-09-04,19936,9691\n2025-09-05,23951,12360\n2025-09-06,30603,13850\n2025-09-07,28918,12757\n2025-09-08,24131,12230\n2025-09-09,35863,18287\n2025-09-10,48288,24221\n2025-09-11,52329,24617\n2025-09-12,36041,19528\n2025-09-13,32535,16077\n2025-09-14,26038,12478\n2025-09-15,21109,10391\n2025-09-16,10719,6652\n2025-09-17,17028,8854\n2025-09-18,9544,5297\n2025-09-19,19994,8842\n2025-09-20,20814,9584\n2025-09-21,20262,9135\n2025-09-22,13577,7857\n2025-09-23,17496,9573\n2025-09-24,11846,7792\n2025-09-25,4449,3515\n2025-09-26,9899,6299\n2025-09-27,11831,7399\n2025-09-28,34782,11277\n2025-09-29,15724,9037\n2025-09-30,20618,11131\n2025-10-01,35860,14162\n2025-10-02,24195,6561\n2025-10-03,17005,8790\n2025-10-04,24278,10332\n2025-10-05,26185,10540\n2025-10-06,17069,8120\n2025-10-07,16869,8065\n2025-10-08,26383,11583\n2025-10-09,24602,10984\n2025-10-10,20483,8491\n2025-10-11,2730,2073\n2025-10-12,17545,8035\n2025-10-13,18969,9080\n2025-10-14,17406,8593\n2025-10-15,21524,9880\n2025-10-16,22424,10926\n2025-10-17,8097,5464\n2025-10-18,23801,10430\n2025-10-19,20055,9171\n2025-10-20,30329,13096\n2025-10-21,33500,13116\n2025-10-22,39876,16104\n2025-10-23,48698,19547\n2025-10-24,33374,14854\n2025-10-25,26577,11674\n2025-10-26,25840,11054\n2025-10-27,27038,13070\n2025-10-28,33368,14610\n2025-10-29,41435,15501\n2025-10-30,16949,7629\n2025-10-31,30275,13033\n2025-11-01,51525,15483\n2025-11-02,46114,13435\n2025-11-03,16159,7763\n2025-11-04,8863,4534\n2025-11-05,12999,6967\n2025-11-06,8510,4778\n2025-11-07,7661,4311\n2025-11-08,21543,8911\n2025-11-09,32671,12558\n2025-11-10,36117,13970\n2025-11-11,42601,15820\n2025-11-12,39823,15505\n2025-11-13,34006,12685\n2025-11-14,26134,12252\n2025-11-15,66938,20248\n2025-11-16,49885,17555\n2025-11-17,54410,18778\n2025-11-18,42797,17386\n2025-11-19,42897,15471\n2025-11-20,25158,10241\n2025-11-21,23510,9421\n2025-11-22,33278,15107\n2025-11-23,24845,11739\n2025-11-24,38867,14638\n2025-11-25,52289,18349\n2025-11-26,88689,26450\n2025-11-27,83680,26057\n2025-11-28,79985,27289\n2025-11-29,47068,15835\n2025-11-30,47904,15245\n2025-12-01,79038,24892\n2025-12-02,84257,26424\n2025-12-03,77949,28038\n2025-12-04,77705,24659\n2025-12-05,77023,23721\n2025-12-06,85983,24551\n2025-12-07,35640,11371\n2025-12-08,30671,9811\n2025-12-09,59965,18333\n2025-12-10,62082,20120\n2025-12-11,79934,21275\n2025-12-12,50070,16757\n2025-12-13,57530,14443\n2025-12-14,72850,16125\n2025-12-15,87167,20858\n2025-12-16,111274,25974\n2025-12-17,100295,21718\n2025-12-18,95544,20442\n2025-12-19,92531,20658\n2025-12-20,100258,22466\n2025-12-21,102462,22040\n2025-12-22,102587,32526\n2025-12-23,121039,42009\n2025-12-24,152012,46226\n2025-12-25,108864,29058\n2025-12-26,141245,35913\n2025-12-27,150392,37330\n2025-12-28,146452,36766\n2025-12-29,128553,41817\n2025-12-30,129872,40903\n2025-12-31,111213,34101\n2026-01-01,122679,33643\n2026-01-02,136414,39403\n2026-01-03,115645,32154\n2026-01-04,109668,30829\n2026-01-05,128237,39356\n2026-01-06,111205,35172\n2026-01-07,128336,34863\n2026-01-08,154329,38225\n2026-01-09,199525,41107\n2026-01-10,230991,39878\n2026-01-11,212302,41103\n2026-01-12,251115,56023\n2026-01-13,314114,63122\n2026-01-14,454199,66892\n2026-01-15,473713,62659\n2026-01-16,434897,54847\n2026-01-17,510147,53423\n2026-01-18,362720,51878\n2026-01-19,421793,62610\n2026-01-20,230369,49940\n2026-01-21,172087,39569\n2026-01-22,231597,48353\n2026-01-23,220291,49717\n2026-01-24,194721,43066\n2026-01-25,214503,38937\n2026-01-26,261826,48545\n2026-01-27,244851,49446\n2026-01-28,257798,55053\n2026-01-29,168455,42993\n2026-01-30,136550,52371\n2026-01-31,134293,43755\n2026-02-01,162166,48852\n2026-02-02,146107,42700\n2026-02-03,166781,49003\n2026-02-04,185495,58395\n2026-02-05,129342,49370\n2026-02-06,177491,54531\n2026-02-07,151187,41444\n2026-02-08,191041,42983\n2026-02-09,332679,57081\n2026-02-10,352850,55154\n2026-02-11,313161,46773\n2026-02-12,202763,41736\n2026-02-13,302786,56301";

        var GAS_RAW = "2025-09-01,1.7201\n2025-09-02,0.6625\n2025-09-03,0.7936\n2025-09-04,0.9930\n2025-09-05,0.7066\n2025-09-06,0.3270\n2025-09-07,0.2605\n2025-09-08,0.9337\n2025-09-09,0.7039\n2025-09-10,0.8298\n2025-09-11,0.6053\n2025-09-12,0.7226\n2025-09-13,0.3605\n2025-09-14,0.2900\n2025-09-15,1.1027\n2025-09-16,1.0277\n2025-09-17,0.7874\n2025-09-18,1.3403\n2025-09-19,0.6604\n2025-09-20,0.3317\n2025-09-21,0.2478\n2025-09-22,0.7822\n2025-09-23,0.6128\n2025-09-24,0.5844\n2025-09-25,1.4301\n2025-09-26,0.8742\n2025-09-27,0.4163\n2025-09-28,0.3206\n2025-09-29,1.4763\n2025-09-30,1.0401\n2025-10-01,1.0113\n2025-10-02,0.9541\n2025-10-03,0.7462\n2025-10-04,0.2779\n2025-10-05,0.2658\n2025-10-06,1.1161\n2025-10-07,0.9822\n2025-10-08,0.5984\n2025-10-09,0.8310\n2025-10-10,1.3988\n2025-10-11,1.6760\n2025-10-12,0.7355\n2025-10-13,0.8430\n2025-10-14,0.9975\n2025-10-15,0.9178\n2025-10-16,0.7823\n2025-10-17,1.7471\n2025-10-18,0.2720\n2025-10-19,0.2435\n2025-10-20,0.2913\n2025-10-21,0.4937\n2025-10-22,0.4171\n2025-10-23,0.2717\n2025-10-24,0.3541\n2025-10-25,0.1688\n2025-10-26,0.2013\n2025-10-27,0.6271\n2025-10-28,0.3804\n2025-10-29,0.5672\n2025-10-30,0.8695\n2025-10-31,0.3830\n2025-11-01,0.1502\n2025-11-02,0.2228\n2025-11-03,1.1484\n2025-11-04,2.1645\n2025-11-05,1.0092\n2025-11-06,1.3122\n2025-11-07,1.5660\n2025-11-08,0.2331\n2025-11-09,0.1496\n2025-11-10,0.5151\n2025-11-11,0.4085\n2025-11-12,0.3369\n2025-11-13,0.8431\n2025-11-14,0.8500\n2025-11-15,0.1265\n2025-11-16,0.2288\n2025-11-17,0.7353\n2025-11-18,0.5951\n2025-11-19,0.6493\n2025-11-20,0.9943\n2025-11-21,1.4760\n2025-11-22,0.1612\n2025-11-23,0.1331\n2025-11-24,0.4478\n2025-11-25,0.3218\n2025-11-26,0.1179\n2025-11-27,0.0694\n2025-11-28,0.1363\n2025-11-29,0.0576\n2025-11-30,0.0582\n2025-12-01,0.2707\n2025-12-02,0.1660\n2025-12-03,0.0766\n2025-12-04,0.0711\n2025-12-05,0.0713\n2025-12-06,0.0374\n2025-12-07,0.4823\n2025-12-08,0.4442\n2025-12-09,0.3388\n2025-12-10,0.2292\n2025-12-11,0.1875\n2025-12-12,0.1392\n2025-12-13,0.0650\n2025-12-14,0.0744\n2025-12-15,0.1724\n2025-12-16,0.0834\n2025-12-17,0.1003\n2025-12-18,0.0893\n2025-12-19,0.1333\n2025-12-20,0.0347\n2025-12-21,0.0384\n2025-12-22,0.0502\n2025-12-23,0.0579\n2025-12-24,0.0448\n2025-12-25,0.0434\n2025-12-26,0.0516\n2025-12-27,0.0387\n2025-12-28,0.0386\n2025-12-29,0.0988\n2025-12-30,0.1000\n2025-12-31,0.1072\n2026-01-01,0.0617\n2026-01-02,0.1120\n2026-01-03,0.0676\n2026-01-04,0.0649\n2026-01-05,0.1396\n2026-01-06,0.2064\n2026-01-07,0.1177\n2026-01-08,0.1063\n2026-01-09,0.0763\n2026-01-10,0.0388\n2026-01-11,0.0414\n2026-01-12,0.0759\n2026-01-13,0.1013\n2026-01-14,0.1192\n2026-01-15,0.1382\n2026-01-16,0.0510\n2026-01-17,0.0398\n2026-01-18,0.0366\n2026-01-19,0.0617\n2026-01-20,0.1036\n2026-01-21,0.1350\n2026-01-22,0.0806\n2026-01-23,0.0860\n2026-01-24,0.0572\n2026-01-25,0.0711\n2026-01-26,0.1045\n2026-01-27,0.0962\n2026-01-28,0.1142\n2026-01-29,0.1192\n2026-01-30,0.3234\n2026-01-31,0.2526\n2026-02-01,0.1835\n2026-02-02,0.3071\n2026-02-03,0.2407\n2026-02-04,0.2733\n2026-02-05,1.3111\n2026-02-06,0.5436\n2026-02-07,0.1675\n2026-02-08,0.0733\n2026-02-09,0.0982\n2026-02-10,0.0951\n2026-02-11,0.1153\n2026-02-12,0.1348\n2026-02-13,0.0791";

        var PRE_AVG_TX = 30040;
        var PRE_AVG_VIC = 12363;
        var FUSAKA_DATE = "2025-12-03";

        function parseData(raw) {
            return raw.split("\n").map(function(line) {
                var parts = line.split(",");
                return { date: parts[0], dustTx: +parts[1], dustVic: +parts[2] };
            });
        }

        function parseGas(raw) {
            var map = {};
            raw.split("\n").forEach(function(line) {
                var parts = line.split(",");
                map[parts[0]] = +parts[1];
            });
            return map;
        }

        function computeMA(data, field, windowSize, gasMap) {
            return data.map(function(d, i) {
                var start = Math.max(0, i - windowSize + 1);
                var slice = data.slice(start, i + 1);
                var sum = 0;
                for (var j = 0; j < slice.length; j++) sum += slice[j][field];
                var ma = Math.round(sum / slice.length);

                var gasSum = 0, gasCount = 0;
                for (var k = start; k <= i; k++) {
                    var g = gasMap[data[k].date];
                    if (g !== undefined) { gasSum += g; gasCount++; }
                }
                var gasMA = gasCount > 0 ? +(gasSum / gasCount).toFixed(4) : null;

                return { date: d.date, ma: ma, gas: gasMA };
            });
        }

        var data = parseData(RAW);
        var gasMap = parseGas(GAS_RAW);
        var maTx = computeMA(data, "dustTx", 7, gasMap);
        var maVic = computeMA(data, "dustVic", 7, gasMap);

        var labels = maTx.map(function(d) { return d.date.slice(5); });
        var fullLabels = maTx.map(function(d) { return d.date; });
        var fusakaIndex = fullLabels.indexOf(FUSAKA_DATE);

        var chartFont = { family: "'Inter', sans-serif" };

        function makeFusakaAnnotation(idx) {
            return {
                type: 'line',
                xMin: idx, xMax: idx,
                borderColor: '#dc3545',
                borderWidth: 1.5,
                borderDash: [4, 3],
                label: {
                    display: true,
                    content: 'Fusaka',
                    position: 'end',
                    backgroundColor: '#fef2f2',
                    color: '#dc3545',
                    font: { size: 11, weight: 600, family: chartFont.family },
                    padding: { top: 3, bottom: 3, left: 8, right: 8 },
                    borderRadius: 3
                }
            };
        }

        function makeBaselineAnnotation(value, label) {
            return {
                type: 'line',
                yMin: value, yMax: value,
                borderColor: '#2a7a2a',
                borderWidth: 1.5,
                borderDash: [6, 3],
                label: {
                    display: true,
                    content: label,
                    position: 'end',
                    backgroundColor: 'transparent',
                    color: '#2a7a2a',
                    font: { size: 11, weight: 500, family: chartFont.family },
                    padding: 0,
                    yAdjust: -12
                }
            };
        }

        function fmtK(n) {
            if (n >= 1e6) return (n / 1e6).toFixed(1) + "M";
            if (n >= 1e3) return (n / 1e3).toFixed(0) + "K";
            return n.toString();
        }

        var commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { top: 28 } },
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#fff',
                    titleColor: '#999',
                    bodyColor: '#333',
                    borderColor: '#ddd',
                    borderWidth: 1,
                    titleFont: { size: 11, family: chartFont.family },
                    bodyFont: { size: 12, family: chartFont.family },
                    padding: { top: 6, bottom: 6, left: 10, right: 10 },
                    boxPadding: 4,
                    callbacks: {
                        label: function(ctx) {
                            if (ctx.dataset.label === 'baseline' || ctx.dataset.label === 'fill') return null;
                            return ctx.dataset.label + ': ' + fmtK(ctx.parsed.y);
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#999', font: { size: 10, family: chartFont.family }, maxRotation: 0, autoSkip: true, maxTicksLimit: 12 },
                    grid: { display: false },
                    border: { color: '#ddd' }
                },
                y: {
                    ticks: { color: '#999', font: { size: 10, family: chartFont.family }, callback: fmtK },
                    grid: { color: '#eee', drawBorder: false },
                    border: { display: false }
                }
            }
        };

        window.chartConfigs = {};

        // Chart 1: Dust transactions
        var cfg1 = {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'fill',
                        data: maTx.map(function(d) { return d.ma; }),
                        backgroundColor: 'rgba(220,53,69,0.08)',
                        borderWidth: 0,
                        fill: true,
                        pointRadius: 0,
                        tension: 0.3
                    },
                    {
                        label: '7d avg transactions',
                        data: maTx.map(function(d) { return d.ma; }),
                        borderColor: '#dc3545',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                        tension: 0.3
                    }
                ]
            },
            options: Object.assign({}, commonOptions, {
                scales: Object.assign({}, commonOptions.scales, {
                    y: Object.assign({}, commonOptions.scales.y, { max: 460000 })
                }),
                plugins: Object.assign({}, commonOptions.plugins, {
                    annotation: {
                        annotations: {
                            fusaka: makeFusakaAnnotation(fusakaIndex),
                            baseline: makeBaselineAnnotation(PRE_AVG_TX, 'Pre-Fusaka avg')
                        }
                    }
                })
            })
        };
        window.chartConfigs.chart1 = cfg1;
        new Chart(document.getElementById('chart1').getContext('2d'), cfg1);

        // Chart 2: Unique wallets
        var cfg2 = {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'fill',
                        data: maVic.map(function(d) { return d.ma; }),
                        backgroundColor: 'rgba(0,123,255,0.08)',
                        borderWidth: 0,
                        fill: true,
                        pointRadius: 0,
                        tension: 0.3
                    },
                    {
                        label: '7d avg wallets',
                        data: maVic.map(function(d) { return d.ma; }),
                        borderColor: '#007bff',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                        tension: 0.3
                    }
                ]
            },
            options: Object.assign({}, commonOptions, {
                plugins: Object.assign({}, commonOptions.plugins, {
                    annotation: {
                        annotations: {
                            fusaka: makeFusakaAnnotation(fusakaIndex),
                            baseline: makeBaselineAnnotation(PRE_AVG_VIC, 'Pre-Fusaka avg')
                        }
                    }
                })
            })
        };
        window.chartConfigs.chart2 = cfg2;
        new Chart(document.getElementById('chart2').getContext('2d'), cfg2);

        // Chart 3: Gas vs Dust (dual axis)
        var cfg3 = {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Gas fill',
                        data: maTx.map(function(d) { return d.gas; }),
                        backgroundColor: 'rgba(232,168,56,0.15)',
                        borderWidth: 0,
                        fill: true,
                        pointRadius: 0,
                        tension: 0.3,
                        yAxisID: 'yGas'
                    },
                    {
                        label: 'Gas price (gwei)',
                        data: maTx.map(function(d) { return d.gas; }),
                        borderColor: '#e8a838',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                        tension: 0.3,
                        yAxisID: 'yGas'
                    },
                    {
                        label: 'Dust transactions',
                        data: maTx.map(function(d) { return d.ma; }),
                        borderColor: '#dc3545',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                        tension: 0.3,
                        yAxisID: 'yTx'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 28 } },
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#fff',
                        titleColor: '#999',
                        bodyColor: '#333',
                        borderColor: '#ddd',
                        borderWidth: 1,
                        titleFont: { size: 11, family: chartFont.family },
                        bodyFont: { size: 12, family: chartFont.family },
                        padding: { top: 6, bottom: 6, left: 10, right: 10 },
                        boxPadding: 4,
                        callbacks: {
                            label: function(ctx) {
                                if (ctx.dataset.label === 'Gas fill') return null;
                                if (ctx.dataset.yAxisID === 'yGas') return ctx.dataset.label + ': ' + (ctx.parsed.y != null ? ctx.parsed.y.toFixed(2) + ' gwei' : 'â€”');
                                return ctx.dataset.label + ': ' + fmtK(ctx.parsed.y);
                            }
                        }
                    },
                    annotation: {
                        annotations: {
                            fusaka: makeFusakaAnnotation(fusakaIndex)
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#999', font: { size: 10, family: chartFont.family }, maxRotation: 0, autoSkip: true, maxTicksLimit: 12 },
                        grid: { display: false },
                        border: { color: '#ddd' }
                    },
                    yGas: {
                        position: 'left',
                        max: 2.5,
                        ticks: { color: '#e8a838', font: { size: 10, family: chartFont.family }, callback: function(v) { return v.toFixed(1); } },
                        grid: { color: '#eee', drawBorder: false },
                        border: { display: false }
                    },
                    yTx: {
                        position: 'right',
                        max: 460000,
                        ticks: { color: '#dc3545', font: { size: 10, family: chartFont.family }, callback: fmtK },
                        grid: { display: false },
                        border: { display: false }
                    }
                }
            }
        };
        window.chartConfigs.chart3 = cfg3;
        new Chart(document.getElementById('chart3').getContext('2d'), cfg3);
    })();
    </script>

    <div class="chart-modal-overlay" id="chartModal" onclick="if(event.target===this)closeModal()">
        <div class="chart-modal">
            <button class="chart-modal-close" onclick="closeModal()">&times;</button>
            <h3 id="modalTitle"></h3>
            <p class="chart-subtitle" id="modalSubtitle"></p>
            <div class="chart-modal-container"><canvas id="modalCanvas"></canvas></div>
        </div>
    </div>

    <script>
    var chartInstances = {};
    document.querySelectorAll('.chart-container canvas').forEach(function(c) {
        var inst = Chart.getChart(c);
        if (inst) chartInstances[c.id] = inst;
    });

    function downloadChart(id, name) {
        var chart = chartInstances[id];
        var cfg = window.chartConfigs[id];
        if (!chart || !cfg) return;
        var box = document.getElementById(id).closest('.chart-box');
        var title = box.querySelector('h3').textContent;
        var subtitle = box.querySelector('.chart-subtitle').textContent;
        var legendItems = [];
        box.querySelectorAll('.chart-legend > span').forEach(function(span) {
            var line = span.querySelector('.legend-line');
            var dash = span.querySelector('.legend-dash');
            legendItems.push({
                text: span.textContent.trim(),
                color: line ? line.style.backgroundColor || line.style.background : '#999',
                isDash: !!dash
            });
        });

        var chartW = 1400;
        var chartH = 620;
        var pad = 48;
        var topH = 110;
        var botH = 80;

        // Render chart natively at target size using an offscreen canvas
        var offCanvas = document.createElement('canvas');
        offCanvas.width = chartW;
        offCanvas.height = chartH;
        var offChart = new Chart(offCanvas.getContext('2d'), {
            type: cfg.type,
            data: {
                labels: chart.data.labels.slice(),
                datasets: chart.data.datasets.map(function(ds) {
                    return Object.assign({}, ds, { data: ds.data.slice() });
                })
            },
            options: Object.assign({}, cfg.options, {
                responsive: false,
                animation: false,
                devicePixelRatio: 1
            })
        });

        // Compose final image
        var tmp = document.createElement('canvas');
        tmp.width = chartW + pad * 2;
        tmp.height = chartH + topH + botH;
        var ctx = tmp.getContext('2d');

        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, tmp.width, tmp.height);

        var fontBase = "Inter, -apple-system, sans-serif";
        ctx.fillStyle = '#333';
        ctx.font = '600 26px ' + fontBase;
        ctx.fillText(title, pad, pad + 28);
        ctx.fillStyle = '#888';
        ctx.font = '20px ' + fontBase;
        ctx.fillText(subtitle, pad, pad + 58);

        ctx.drawImage(offCanvas, pad, topH);

        var ly = topH + chartH + 36;
        var lx = pad;
        ctx.font = '18px ' + fontBase;
        legendItems.forEach(function(item) {
            var sw = 26;
            if (item.isDash) {
                ctx.save();
                ctx.setLineDash([6, 4]);
                ctx.strokeStyle = '#999';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(lx, ly - 6);
                ctx.lineTo(lx + sw, ly - 6);
                ctx.stroke();
                ctx.restore();
            } else {
                ctx.fillStyle = item.color;
                ctx.fillRect(lx, ly - 10, sw, 5);
            }
            lx += sw + 8;
            ctx.fillStyle = '#555';
            ctx.fillText(item.text, lx, ly);
            lx += ctx.measureText(item.text).width + 36;
        });

        ctx.fillStyle = '#bbb';
        ctx.font = '18px ' + fontBase;
        ctx.textAlign = 'right';
        ctx.fillText('sergeenkov.com', tmp.width - pad, tmp.height - 20);

        offChart.destroy();

        var link = document.createElement('a');
        link.download = name + '.png';
        link.href = tmp.toDataURL('image/png');
        link.click();
    }

    var modalChart = null;
    function expandChart(id) {
        var src = chartInstances[id];
        var cfg = window.chartConfigs[id];
        if (!src || !cfg) return;
        var box = document.getElementById(id).closest('.chart-box');
        document.getElementById('modalTitle').textContent = box.querySelector('h3').textContent;
        document.getElementById('modalSubtitle').textContent = box.querySelector('.chart-subtitle').textContent;
        document.getElementById('chartModal').classList.add('active');
        document.body.style.overflow = 'hidden';

        if (modalChart) { modalChart.destroy(); modalChart = null; }

        var modalCfg = {
            type: cfg.type,
            data: {
                labels: src.data.labels.slice(),
                datasets: src.data.datasets.map(function(ds) {
                    return Object.assign({}, ds, { data: ds.data.slice() });
                })
            },
            options: cfg.options
        };

        var mCanvas = document.getElementById('modalCanvas');
        modalChart = new Chart(mCanvas.getContext('2d'), modalCfg);
    }

    function closeModal() {
        document.getElementById('chartModal').classList.remove('active');
        document.body.style.overflow = '';
        if (modalChart) { modalChart.destroy(); modalChart = null; }
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeModal();
    });
    </script>
</body>
</html>
